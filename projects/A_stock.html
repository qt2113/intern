<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ˆ Aè‚¡è‚¡ç¥¨è‚¡ä¸œç»“æ„æ¯”ä¾‹åˆ†æ</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 40px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      color: #2c3e50;
    }
    pre {
      background: #f4f4f4;
      padding: 15px;
      overflow-x: auto;
      border-left: 4px solid #2980b9;
    }
    code {
      font-family: monospace;
    }
    a {
      color: #2980b9;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>ğŸ“ˆ Aè‚¡è‚¡ç¥¨è‚¡ä¸œç»“æ„æ¯”ä¾‹åˆ†æ</h1>
  <p>æœ¬æ¨¡å—æ—¨åœ¨åŸºäºWindå¯¼å‡ºçš„æ•°æ®ï¼Œåˆ†æ2024å¹´ä¸2025å¹´å¸‚å€¼30äº¿å…ƒä»¥ä¸‹Aè‚¡å…¬å¸ä¸­ï¼Œå‰åå¤§æµé€šè‚¡ä¸œçš„æœºæ„ã€äº§å“ã€è‡ªç„¶äººä¸‰ç±»æŒè‚¡æ¯”ä¾‹å˜åŒ–ã€‚é€šè¿‡Pythonè„šæœ¬è‡ªåŠ¨åˆ†ç±»è‚¡ä¸œç±»å‹ï¼Œæ‰¹é‡ç»Ÿè®¡ï¼Œæœ€åä½¿ç”¨Excelå†…ç½®å‡½æ•°è®¡ç®—å‡ºç»“æ„å æ¯”ç»“æœï¼Œç”¨äºè§‚å¯ŸæŒè‚¡è¶‹åŠ¿å˜åŒ–ã€‚</p>

  <h2>æ“ä½œæµç¨‹</h2>
  <ol>
    <li><b>æ•°æ®å¯¼å‡ºä¸æ•´ç†</b>
      <dt>- é€šè¿‡Windç»ˆç«¯åˆ†åˆ«å¯¼å‡º2024å¹´ä¸2025å¹´æ—¶ç‚¹å¸‚å€¼ä¸è¶…è¿‡30äº¿å…ƒçš„Aè‚¡å…¬å¸æ•°æ®ï¼Œå­—æ®µåŒ…æ‹¬ï¼šè¯åˆ¸ä»£ç ã€è¯åˆ¸ç®€ç§°ã€æµé€šå¸‚å€¼ï¼›å‰åå¤§æµé€šè‚¡ä¸œåç§°åŠå…¶å¯¹åº”æŒè‚¡æ¯”ä¾‹ï¼›</dt>  
      <dt>- ç­›é€‰ä¸¤æœŸæ•°æ®ä¸­è¯åˆ¸ä»£ç äº¤é›†éƒ¨åˆ†ï¼Œç¡®ä¿åˆ†æå¯¹è±¡ä¸ºä¸¤ä¸ªæ—¶é—´ç‚¹å‡å­˜åœ¨çš„å…¬å¸ï¼Œåˆå¹¶ä¸ºç»Ÿä¸€æ ¼å¼è¡¨æ ¼ä»¥ä¾›åç»­å¤„ç†ã€‚</dt>
    </li>

    <li><b>è‚¡ä¸œåˆ†ç±»ä¸ç»Ÿè®¡</b>
      <dt>- è‡ªå®šä¹‰ classify_holder å‡½æ•°ï¼Œå°†å‰åå¤§è‚¡ä¸œåç§°åˆ†ä¸ºä¸‰ç±»ï¼š</dt>  
        <dd>- æœºæ„ç±»ï¼šåŒ…æ‹¬å„ç±»å…¬å¸ã€åŸºé‡‘ç®¡ç†äººã€é“¶è¡Œã€ä¿¡æ‰˜ç­‰ï¼›</dd>
        <dd>- äº§å“ç±»ï¼šåŒ…æ‹¬å„ç±»åŸºé‡‘ã€èµ„ç®¡è®¡åˆ’ã€ä¿¡æ‰˜äº§å“ã€ETFç­‰ï¼›</dd>
        <dd>- è‡ªç„¶äººç±»ï¼šä¸­æ–‡äººåæˆ–ä¸ç¬¦åˆä»¥ä¸Šä¸¤ç±»çš„ä¸»ä½“ï¼›</dd>
      <dt>- ç”¨pythonè„šæœ¬éå†æ¯å®¶å…¬å¸å‰åå¤§è‚¡ä¸œï¼Œè¯†åˆ«ç±»åˆ«åæŒ‰æŒè‚¡æ¯”ä¾‹ç»Ÿè®¡ï¼š</dt>  
        <dd>- è¾“å‡ºæ¯å®¶å…¬å¸ä¸‰ç±»è‚¡ä¸œå æ¯”ã€æ€»å æ¯”ã€æµé€šå¸‚å€¼ç­‰å­—æ®µï¼›</dd>
        <dd>- æ”¯æŒæ‰¹é‡å¤„ç†å¹¶è¾“å‡ºä¸ºExcelæ–‡ä»¶</dd>
    </li>

    <li><b>ç»“æœè¾“å‡º</b>
      <dt>- ç”ŸæˆåŒ…å«è¯åˆ¸ä»£ç ã€ç®€ç§°ã€æµé€šå¸‚å€¼ã€ä¸‰ç±»è‚¡ä¸œå æ¯”ç­‰å­—æ®µçš„Excelæ–‡ä»¶ï¼›</dt>  
      <dt>- æ”¯æŒå†™å…¥å¤šä¸ªsheetï¼Œä¾¿äºä¸åŒå¹´ä»½æ¨ªå‘å¯¹æ¯”;</dt>
      <dt>- é…åˆExcelè¿›è¡Œå æ¯”å˜åŒ–è®¡ç®—ä¸åˆ†æ</dt>
    </li>
  </ol>

  <h2>ğŸ“„ Python æºä»£ç </h2>

  <h3>è‚¡ä¸œå¯¹æ¯”.py</h3>
    <details>
        <summary>ç‚¹å‡»å±•å¼€/æŠ˜å ä»£ç </summary>
        <div style="position: relative;">
            <button onclick="copyCode(this)" style="position: absolute; top: 8px; right: 8px; z-index: 2; font-size: 12px; padding: 2px 8px; cursor: pointer;">å¤åˆ¶ä»£ç </button>
            <pre><code>
    <!-- æ›¿æ¢ä¸ºå®é™…æ–‡ä»¶å†…å®¹ -->
    import pandas as pd
    import re
    from openpyxl import load_workbook

    # --- è‚¡ä¸œåˆ†ç±»å‡½æ•° ---
    def classify_holder(name):
        if pd.isna(name):
            return 'æœªçŸ¥'

        name = str(name).strip()
        name_cn = name  # ä¸­æ–‡åŸæ ·
        name_en = name  # è‹±æ–‡æ£€æŸ¥æ—¶å¤„ç†

        # --- 1. åˆ¤æ–­äº§å“ ---
        product_keywords = [
            'åŸºé‡‘', 'èµ„ç®¡', 'ç†è´¢', 'ä¸“æˆ·', 'è®¡åˆ’', 'ç»„åˆ', 'äº§å“', 'å¥‘çº¦å‹',
            'é›†åˆèµ„é‡‘ä¿¡æ‰˜', 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’', 'å…»è€é‡‘äº§å“', 'ä¿é™©äº§å“', 'å°é—­å¼åŸºé‡‘',
            'é›†åˆè®¡åˆ’', 'èµ„äº§æ”¯æŒè¯åˆ¸', 'ä¿¡æ‰˜è®¡åˆ’', 'æŠ•èµ„åŸºé‡‘', 'åˆ›ä¸šæŠ•èµ„', 'ç§å‹Ÿè‚¡æƒ','è‡ªæœ‰èµ„é‡‘','ETF','FUND','L.P.','LP'
        ]
        if any(k in name_cn for k in product_keywords):
            # é˜²æ­¢â€œåŸºé‡‘ç®¡ç†æœ‰é™å…¬å¸â€è¢«é”™åˆ¤æˆäº§å“
            institution_suffixes = [
                'æŠ•èµ„æœ‰é™å…¬å¸', 'ç®¡ç†æœ‰é™å…¬å¸', 'æœ‰é™å…¬å¸', 'èµ„äº§ç®¡ç†æœ‰é™å…¬å¸', 'èµ„äº§ç®¡ç†å…¬å¸',
                'åŸºé‡‘ç®¡ç†å…¬å¸', 'ä¿¡æ‰˜å…¬å¸', 'è¯åˆ¸å…¬å¸', 'é“¶è¡Œ', 'è´¢åŠ¡å…¬å¸', 'ä¿é™©',
                'èµ„æœ¬', 'åˆ›æŠ•', 'é›†å›¢', 'å›½èµ„', 'åŸºé‡‘ç®¡ç†äºº', 'æœ‰é™åˆä¼™',
                'åˆä¼™ä¼ä¸š', 'äº‹åŠ¡æ‰€', 'è´¦æˆ·', 'å‘å±•ä¸­å¿ƒ'
            ]
            if not any(name_cn.endswith(suffix) for suffix in institution_suffixes):
                return 'äº§å“'

        # --- 2. åˆ¤æ–­æœºæ„ï¼ˆä¸­æ–‡ï¼‰ ---
        institution_keywords = [
            'æŠ•èµ„æœ‰é™å…¬å¸', 'ç®¡ç†æœ‰é™å…¬å¸', 'æœ‰é™å…¬å¸', 'èµ„äº§ç®¡ç†æœ‰é™å…¬å¸', 'èµ„äº§ç®¡ç†å…¬å¸',
            'åŸºé‡‘ç®¡ç†å…¬å¸', 'ä¿¡æ‰˜å…¬å¸', 'è¯åˆ¸å…¬å¸', 'é“¶è¡Œ', 'è´¢åŠ¡å…¬å¸', 'ä¿é™©',
            'èµ„æœ¬', 'åˆ›æŠ•', 'é›†å›¢', 'å›½èµ„', 'åŸºé‡‘ç®¡ç†äºº', 'æœ‰é™åˆä¼™', 'åˆä¼™ä¼ä¸š','ç®¡ç†ä¸­å¿ƒ','æ ªå¼ä¼šç¤¾','å¤§å­¦','ç¤¾','å†œåœº','ç®¡ç†å¤„',
            'äº‹åŠ¡æ‰€', 'è´¦æˆ·', 'å‘å±•ä¸­å¿ƒ','å…¬å¸','ç®¡ç†ç«™','è´¢æ”¿å±€','è´¢æ”¿å…','åŠå…¬å®¤','ç ”ç©¶æ‰€','ç§‘å­¦é™¢','ç ”ç©¶é™¢','ä¸­å¿ƒ','å§”å‘˜ä¼š','åŒ»é™¢','æŠ•èµ„å±€','åˆ¶è¯å‚'
        ]
        if any(name_cn.endswith(k) or k in name_cn for k in institution_keywords):
            return 'æœºæ„'

        # --- 3. åˆ¤æ–­è‹±æ–‡æœºæ„ ---
        english_institution_keywords = [
            'BANK', 'SECURITIES', 'TRUST', 'INVESTMENT', 'ASSETMANAGEMENT', 'LIMITED', 'LIMITED.', 'INCORPORATED', 'INCORPORATED.', 'INTERNATIONAL', 'LIMITSD'
        ]
        english_suffixes = [
            'LTD', 'INC', 'LLC', 'CO.,LTD.', 'PLC', 'INC.', 'PLC.', 'CORP.', 'BHD.', 'LTD.','CORPORATION', 'COMPANY', 'BANKING','INCORPORATED', 'SA', 'AG', 'ED'
        ]
        well_known_institutions = [
            'UBS AG', 'MORGAN STANLEY', 'JPMORGAN CHASE BANK N.A.',
            'GOLDMAN SACHS', 'HSBC', 'CREDIT SUISSE', 'CITI','SA','AG'
        ]
        # ç»Ÿä¸€å¤„ç†è‹±æ–‡åï¼Œå»é™¤ç©ºæ ¼å’Œå¤§å°å†™
        name_en_upper = name_en.upper().replace(' ', '')
        # æ£€æŸ¥è‹±æ–‡æœºæ„å…³é”®è¯å’Œåç¼€ï¼ˆå¿½ç•¥ç©ºæ ¼å’Œå¤§å°å†™ï¼‰
        if (any(k in name_en_upper for k in english_institution_keywords)
            or any(name_en_upper.endswith(s.replace(' ', '')) for s in english_suffixes)
            or any(name_en_upper.endswith(w.replace(' ', '')) for w in well_known_institutions)
            or name_en_upper in (w.upper().replace(' ', '') for w in well_known_institutions)):
            return 'æœºæ„'

        # --- 4. åˆ¤æ–­è‡ªç„¶äººï¼ˆä»…ä¸­æ–‡ 2~4 ä¸ªæ±‰å­—ï¼‰ ---
        if re.fullmatch(r'[\u4e00-\u9fa5]{2,4}', name_cn):
            return 'è‡ªç„¶äºº'

        # --- 5. é»˜è®¤å…œåº• ---
        return 'è‡ªç„¶äºº'


    # --- ä¸»å‡½æ•° ---
    def analyze_shareholders(filepath):
        df = pd.read_excel(filepath, engine='openpyxl')

        # åŸºç¡€åˆ—è¯†åˆ«ï¼ˆè‡ªåŠ¨æå–ï¼‰
        code_col = 'è¯åˆ¸ä»£ç '
        name_col = 'è¯åˆ¸ç®€ç§°'
        mkt_cap_col = [col for col in df.columns if 'æµé€šå¸‚å€¼' in col][0]

        result_rows = []

        for _, row in df.iterrows():
            code = row[code_col]
            stock_name = row[name_col]
            try:
                mkt_cap = float(str(row[mkt_cap_col]).replace(',', '').strip())
            except:
                mkt_cap = None

            total_ratio = {'æœºæ„': 0.0, 'äº§å“': 0.0, 'è‡ªç„¶äºº': 0.0}

            for i in range(1, 11):
                try:
                    holder_name_col = [col for col in df.columns if f'æ’å] ç¬¬{i}å' in col and 'åç§°' in col][0]
                    holder_ratio_col = [col for col in df.columns if f'æ’å] ç¬¬{i}å' in col and 'æ¯”ä¾‹' in col][0]
                    holder_name = row[holder_name_col]
                    ratio = row[holder_ratio_col]

                    holder_type = classify_holder(holder_name)
                    try:
                        ratio_val = float(str(ratio).replace('%', '').replace(',', '').strip())
                    except:
                        ratio_val = 0.0
                    if holder_type in total_ratio:
                        total_ratio[holder_type] += ratio_val
                except:
                    continue

            total_sum = sum(total_ratio.values())
            result_rows.append({
                'è¯åˆ¸ä»£ç ': code,
                'è¯åˆ¸ç®€ç§°': stock_name,
                'æµé€šå¸‚å€¼': mkt_cap,
                'æœºæ„å æ¯”': round(total_ratio['æœºæ„'], 4),
                'äº§å“å æ¯”': round(total_ratio['äº§å“'], 4),
                'è‡ªç„¶äººå æ¯”': round(total_ratio['è‡ªç„¶äºº'], 4),
                'å‰åå¤§è‚¡ä¸œæ€»å æ¯”': round(total_sum, 4)
            })

        result_df = pd.DataFrame(result_rows)
        return result_df

    # --- ä½¿ç”¨ç¤ºä¾‹ï¼ˆè¾“å…¥è·¯å¾„ & è¾“å‡ºè·¯å¾„ï¼‰ ---
    input_path = r"C:\Users\TQY\Desktop\å…¨éƒ¨Aè‚¡-20240630-å‰10åè‚¡ä¸œ.xlsx"  # ä¿®æ”¹ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„
    output_path = r'C:\Users\TQY\Desktop\æ¯è‚¡è‚¡ä¸œç±»å‹å æ¯”ç»“æœ.xlsx'  # è¾“å‡ºç»“æœè·¯å¾„
    sheet_name = 'è‚¡ä¸œç±»å‹å æ¯”'  # æ–°å»ºçš„sheetåç§°

    output_df = analyze_shareholders(input_path)


    try:
        # å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œè¿½åŠ æ–°sheet
        with pd.ExcelWriter(output_path, engine='openpyxl', mode='a', if_sheet_exists='replace') as writer:
            output_df.to_excel(writer, index=False, sheet_name=sheet_name)
    except FileNotFoundError:
        # æ–‡ä»¶ä¸å­˜åœ¨åˆ™æ–°å»º
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            output_df.to_excel(writer, index=False, sheet_name=sheet_name)

    print(f"ç»Ÿè®¡å®Œæˆï¼ç»“æœå·²ä¿å­˜ä¸ºï¼š{output_path}ï¼ŒSheetåä¸ºï¼š{sheet_name}")
            </code></pre>
        </div>
    </details>
    <script>
    function copyCode(btn) {
            const pre = btn.parentElement.querySelector('pre code');
            let text = pre.innerText;
            // Remove leading/trailing empty lines
            text = text.replace(/^\s*\n/, '').replace(/\n\s*$/, '');
            // Create a temporary textarea to copy
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                    document.execCommand('copy');
                    btn.textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => { btn.textContent = 'å¤åˆ¶ä»£ç '; }, 1200);
            } catch (e) {
                    btn.textContent = 'å¤åˆ¶å¤±è´¥';
            }
            document.body.removeChild(textarea);
    }
    </script>


  <h2>ğŸ“¥ é™„ä»¶ä¸‹è½½</h2>
  <ul>
    <li><a href="../assets/A_stock/A_stock_20240630_top10.xlsx" download>å…¨éƒ¨Aè‚¡-20240630-å‰10åè‚¡ä¸œ.xlsx</a></li>
    <li><a href="../assets/A_stock/A_stock_20250708_top10.xlsx" download>å…¨éƒ¨Aè‚¡-20250708-å‰10åè‚¡ä¸œ.xlsx</a></li>
    <li><a href="../assets/A_stock/result.xlsx" download>æ¯è‚¡è‚¡ä¸œç±»å‹å æ¯”ç»“æœ .xlsx</a></li>
  </ul>

  <p><a href="../index.html">â† è¿”å›ä¸»é¡µ</a></p>
</body>
</html>
